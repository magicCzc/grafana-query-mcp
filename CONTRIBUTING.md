<!-- Copyright (c) 2025, Project Grafana Query MCP. All rights reserved. -->

# 贡献指南

欢迎参与 Grafana Query MCP 项目的开发！本文档将帮助您了解如何为项目做出贡献，包括代码贡献、文档改进和问题报告。

## 目录

1. [Git 使用规范](#git-使用规范)
   - [分支管理策略](#分支管理策略)
   - [提交信息格式](#提交信息格式)
   - [Pull Request 流程](#pull-request-流程)
   - [代码冲突解决](#代码冲突解决)

2. [代码贡献](#代码贡献)
   - [开发流程](#开发流程)
   - [代码规范](#代码规范)
   - [测试要求](#测试要求)

3. [文档贡献](#文档贡献)

4. [问题报告](#问题报告)

## Git 使用规范

### 分支管理策略

#### 主要分支

- **main**：主分支，用于发布稳定版本。
  - 只接受来自 `develop` 分支的合并请求。
  - 每次合并后，都应该创建一个新的标签（Tag）。
  - 不允许直接在 `main` 分支上进行开发。

- **develop**：开发分支，用于集成所有特性开发。
  - 所有新特性分支都应该从 `develop` 分支创建。
  - 定期合并到 `main` 分支进行版本发布。

#### 特性分支

用于开发新特性或功能改进：
- 命名格式：`feature/{功能名称}`
- 示例：`feature/query-pagination`、`feature/error-detection`
- 应该从 `develop` 分支创建，并最终合并回 `develop` 分支。

#### 修复分支

用于修复 bug：
- 命名格式：`fix/{问题描述}`
- 示例：`fix/api-timeout`、`fix/pagination-issue`
- 应该从 `develop` 分支创建（紧急 bug 可从 `main` 分支创建），并最终合并回相应的分支。

#### 其他分支

- **release/{版本号}**：版本发布分支，用于准备版本发布。
- **hotfix/{问题描述}**：紧急修复分支，用于修复已发布版本的严重 bug。

### 提交信息格式

提交信息应该清晰、简洁，遵循以下格式：

```
<类型>: <简短描述> [可选的问题编号]

[详细描述（如果需要）]

[额外信息（如影响范围、注意事项等）]
```

#### 提交类型

- **feat**：新特性
- **fix**：修复 bug
- **docs**：文档更新
- **style**：代码格式调整（不影响功能）
- **refactor**：代码重构（不增加新功能或修复 bug）
- **test**：测试相关（增加测试用例或修改现有测试）
- **chore**：构建过程或辅助工具的变动
- **perf**：性能优化
- **ci**：CI/CD 相关配置变更
- **revert**：回退到之前的提交

#### 提交示例

```
feat: 增加查询分页功能

实现了基于 SSE 的查询结果分页返回功能，支持客户端分页请求和同步查询模式。

影响范围：
- query 模块
- API 接口

fix: 修复查询转换错误

解决了在某些情况下查询转换逻辑导致的语法错误问题。

相关问题：#123

docs: 更新 API 文档

补充了查询分页接口的详细说明和使用示例。
```

### Pull Request 流程

1. **创建分支**：
   - 从 `develop` 分支创建特性分支或修复分支。
   - 确保分支名称符合命名规范。

2. **代码开发**：
   - 编写代码并确保符合项目的代码规范。
   - 为新功能或修复添加测试用例。
   - 运行测试确保所有测试通过。

3. **提交代码**：
   - 遵循提交信息格式要求。
   - 保持提交记录清晰、简洁。

4. **推送分支**：
   ```bash
   git push origin <your-branch-name>
   ```

5. **创建 Pull Request**：
   - 在 GitHub 上创建 Pull Request。
   - 标题应该简洁明了，描述功能或修复内容。
   - 填写 Pull Request 模板，包括：
     - 变更的目的和内容
     - 测试情况
     - 相关问题或功能请求

6. **代码审查**：
   - 至少需要 1 位维护者的审查和批准。
   - 审查者将检查代码质量、功能完整性和测试覆盖情况。
   - 根据审查意见进行修改并提交。

7. **合并分支**：
   - 审查通过后，维护者将合并 Pull Request。
   - 删除已合并的分支。

### 代码冲突解决

当多个分支对同一部分代码进行修改时，可能会产生冲突。以下是解决冲突的步骤：

1. **更新本地分支**：
   ```bash
   git checkout develop
   git pull origin develop
   git checkout <your-branch-name>
   git merge develop
   ```

2. **识别冲突**：
   - Git 会标记冲突的文件和位置。
   - 冲突标记：
     ```
     <<<<<<< HEAD
     你的分支的代码
     =======
     develop 分支的代码
     >>>>>>> develop
     ```

3. **解决冲突**：
   - 手动编辑冲突的文件，选择正确的代码或合并两者。
   - 删除冲突标记 `<<<<<<< HEAD`、`=======` 和 `>>>>>>> develop`。

4. **验证修改**：
   - 确保代码可以正常编译和运行。
   - 运行测试确保没有引入新的问题。

5. **提交解决后的代码**：
   ```bash
   git add .
   git commit -m 'resolve conflicts'
   ```

6. **推送到远程分支**：
   ```bash
   git push origin <your-branch-name>
   ```

## 代码贡献

### 开发流程

1. **选择任务**：
   - 从项目的 Issues 或任务列表中选择一个任务。
   - 可以创建新的 Issue 来提出新的功能或 bug 报告。

2. **开发环境设置**：
   - 按照 [开发环境配置文档](docs/development.md) 设置开发环境。

3. **代码编写**：
   - 遵循项目的代码规范和风格指南。
   - 为新功能或修复添加文档。

4. **代码质量**：
   - 运行代码格式化工具：`python -m black app`
   - 运行代码质量检查工具：`python -m ruff app`
   - 确保所有测试通过：`pytest -q`

5. **提交代码**：
   - 遵循提交信息格式要求。
   - 创建 Pull Request 并等待审查。

### 代码规范

- **命名约定**：
  - 变量/函数：`snake_case`（如 `user_profile`, `calculate_score`）
  - 类名：`PascalCase`（如 `UserProfile`, `ProjectTemplate`）
  - 常量：`UPPER_SNAKE_CASE`（如 `MAX_USERS`, `DEFAULT_CONFIG`）

- **代码风格**：
  - 缩进：4 个空格
  - 行长度：不超过 88 字符
  - 导入分组：标准库、第三方库、本地模块

- **注释**：
  - 函数/类必须有详细的文档字符串（docstring）
  - 复杂逻辑必须有行内注释
  - 代码变更必须有提交注释

### 测试要求

- 所有新功能必须有对应的测试用例
- 所有修复必须有对应的回归测试
- 测试覆盖率应该保持在 80% 以上
- 使用 pytest 框架编写测试

## 文档贡献

文档是项目的重要组成部分，您可以通过以下方式改进文档：

- 修复文档中的错误或拼写错误
- 补充文档中的缺失内容
- 改进文档的可读性和结构
- 翻译文档到其他语言

## 问题报告

如果您发现了 bug 或有新的功能请求，请在 GitHub 上创建 Issue：

1. **Bug 报告**：
   - 标题：`bug: <简短描述>`
   - 描述：
     - 详细描述 bug 的表现和复现步骤
     - 提供环境信息（操作系统、Python 版本、Grafana 版本等）
     - 附上相关的日志或错误信息

2. **功能请求**：
   - 标题：`feature: <简短描述>`
   - 描述：
     - 详细描述您希望添加的功能
     - 说明该功能的使用场景和价值
     - 可以提供实现思路或建议

## 贡献者名单

感谢所有为项目做出贡献的开发者！

- [Contributor 1](https://github.com/contributor1)
- [Contributor 2](https://github.com/contributor2)

## 联系我们

如果您有任何问题或建议，可以通过以下方式联系我们：

- GitHub Issues：[项目 Issues 页面](https://github.com/your-org/grafana-query-mcp/issues)
- Email：team@example.com
- Slack：#grafana-query-mcp 频道

## 许可证

项目采用 [MIT 许可证](LICENSE)。